{% extends 'base.html' %} 

{%block app_content%}
<!DOCTYPE html>

<html>
<head>
<style>
ul {
  list-style-type: none;
  margin: 0;
  padding: 0;
  overflow: hidden;
  background-color: rgba(20, 90, 23, 0.877);
}

li {
  float: right;
}

li a {
  display: block;
  color: white;
  text-align: center;
  padding: 14px 16px;
  text-decoration: none;
}

li a:hover {
  background-color: rgb(30, 190, 57);
}

</style>
<div class = "header">
<img src="{{url_for('static', filename='logo.png')}}" align="middle" width="10%" />
</div>
</head>    
    <head>
        <meta charset="utf-8" />
		<title>Trails Data</title>
		<link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.3/dist/leaflet.css" />
		<style>
			body {
				margin:0;
                padding:0;
                font-family: Arial;
                background-color:rgb(241, 235, 221);
			}
			#map {
				position: relative;
				top:0;
				bottom:0;
				width:600px;
				height:400px
			}
			

			li {
			float: right;
			}

			li a {
			display: block;
			color: white;
			text-align: center;
			padding: 14px 16px;
			text-decoration: none;
			}

			li a:hover {
			background-color: #111;
			}
		</style>
    </head>
    
	
    <ul>
        <li><a href= "{{ url_for('logout') }}">Log Out</a></li>
        <li><a href="{{url_for('profile')}}">Profile</a></li>
        <li><a href= "{{ url_for('trails') }}">Map</a></li>
        <li><a class="active" href="{{url_for('home')}}">Home</a></li> 
    </ul>
	
	
	<body>
		<h>Trails Map</h>
        <div id="map"></div>
        
        <!-- selectboxes -->
        <select class="difficulty" multiple="multiple" style="width: 50%">
            <option></option>        
        </select>
        <select class="park_name" multiple="multiple" style="width: 50%">
            <option></option>        
        </select>
        <select class="trail_name" multiple="multiple" style="width: 50%">
            <option></option>        
        </select>
        
        <!-- Ajax/Select2 for selectbox-->
        <script defer src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
        <script defer src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
        <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
        
        <script src="https://unpkg.com/leaflet@1.0.3/dist/leaflet.js"></script>
		<script>
            var center = [40.4406, -79.9959];
			var map = L.map('map', {
			}).setView(center,9);
			
			L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
				maxZoom: 18
			}).addTo(map);
            
            var dataURL = "https://openac-alcogis.opendata.arcgis.com/datasets/d182439a9a6344fca2c5bf717b9cace8_0.geojson?outSR=%7B%22latestWkid%22%3A4019%2C%22wkid%22%3A4019%7D";
			fetch(dataURL)
                .then(response => response.json())
                .then(data => {
                    // Dynamically construct selectbox options
                    var difs = [];
                    var park_names = [];
                    var trail_names = [];
                    
                    for (var i in data.features) {
                        var feature = data.features[i];
                        if (feature.properties.Difficulty !== null && 
                            feature.properties.Difficulty !== " " && 
                            difs.findIndex(element => { if (element.text === feature.properties.Difficulty) { return true; } }) == -1)
                            difs.push({id: difs.length, text: feature.properties.Difficulty});
                        if (feature.properties.Park_Name_Full !== null && 
                            feature.properties.Park_Name_Full !== " " &&
                            park_names.findIndex(element => { if (element.text === feature.properties.Park_Name_Full) { return true; } }) == -1)
                            park_names.push({id: park_names.length, text: feature.properties.Park_Name_Full});
                        if (feature.properties.Trail_Name !== null && 
                            feature.properties.Trail_Name !== " " &&
                            trail_names.findIndex(element => {if (element.text === feature.properties.Trail_Name) { return true; } }) == -1)
                            trail_names.push({id: trail_names.length, text: feature.properties.Trail_Name});
                    }
                    
                    $('.difficulty').select2({
                        data: difs,
                        placeholder: 'Search by difficulty'
                    });

                    $('.park_name').select2({
                        data: park_names,
                        placeholder: 'Search by park name'
                    });
                    
                    $('.trail_name').select2({
                        data: trail_names,
                        placeholder: 'Search by trail name'
                    });
                    
                    // Filter/render
                    let selectBoxStates;
                    
                    function onEachFeature(feature, layer) {
                        layer.bindPopup(`Park Name: ${feature.properties.Park_Name_Full}<br>
                                        Trail Name: ${feature.properties.Trail_Name}<br>
                                        Difficulty: ${feature.properties.Difficulty}`, {offset: L.point(0, -20)});
                        layer.on('mouseover', function() { layer.openPopup(); });
                        layer.on('mouseout', function() { layer.closePopup(); });
                    }

                    const geoJsonLayer = L.geoJSON(null, {
                        filter: (feature) => {
                            if(selectBoxStates.difficulties.length > 0) { // If no checkboxes of a certain class are selected, show all
                                var isDifficultySelected = selectBoxStates.difficulties.includes(feature.properties.Difficulty);
                            } else { isDifficultySelected = true;}
                            if(selectBoxStates.park_names.length > 0) {
                                var isParkSelected = selectBoxStates.park_names.includes(feature.properties.Park_Name_Full);
                            } else { isParkSelected = true;}
                            if(selectBoxStates.trail_names.length > 0) {
                                var isTrailSelected = selectBoxStates.trail_names.includes(feature.properties.Trail_Name);
                            } else { isTrailSelected = true;}
                            
                            return isDifficultySelected && isParkSelected && isTrailSelected; // Need properties of each class to be true to show
                        },
                        onEachFeature, onEachFeature
                    }).addTo(map);
                    
                    function updateSelectboxStates() {
                        selectBoxStates = {
                            difficulties: [],
                            park_names: [],
                            trail_names: []
                        };
                        for (let dif of $('.difficulty').select2('data')) {
                            selectBoxStates.difficulties.push(dif.text);
                        }
                        for (let park of $('.park_name').select2('data')) {
                            selectBoxStates.park_names.push(park.text);
                        }
                        for (let trail of $('.trail_name').select2('data')) {
                            selectBoxStates.trail_names.push(trail.text);
                        }
                    }
                                    
                    for(let select of document.querySelectorAll('select')) {
                        select.onchange = (e) => {
                            geoJsonLayer.clearLayers();
                            updateSelectboxStates();
                            geoJsonLayer.addData(data);
                        }
                    }

                    updateSelectboxStates();
                    geoJsonLayer.addData(data);               
                });
		</script>
    </body>

</html>



{% endblock %}